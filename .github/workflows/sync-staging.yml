name: Sync Staging from Main

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  sync-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Disable staging ruleset
        id: disable-ruleset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get staging ruleset ID
          RULESET_ID=$(gh api "repos/${{ github.repository }}/rulesets" --jq '.[] | select(.name=="staging-protection") | .id' 2>/dev/null || echo "")

          if [ -n "$RULESET_ID" ]; then
            echo "Disabling staging-protection ruleset (ID: $RULESET_ID)..."
            gh api "repos/${{ github.repository }}/rulesets/${RULESET_ID}" -X PUT --input - << EOF
          {
            "name": "staging-protection",
            "enforcement": "disabled"
          }
          EOF
            echo "ruleset_id=$RULESET_ID" >> $GITHUB_OUTPUT
            echo "âœ“ Ruleset disabled"
          else
            echo "No staging-protection ruleset found"
            echo "ruleset_id=" >> $GITHUB_OUTPUT
          fi

      - name: Sync main to staging
        id: sync
        run: |
          # Fetch all branches
          git fetch origin

          # Check if staging exists
          if ! git show-ref --verify --quiet refs/remotes/origin/staging; then
            echo "Staging branch doesn't exist. Creating from main..."
            git checkout -b staging
            git push -u origin staging
            echo "result=created" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Checkout staging
          git checkout staging
          git pull origin staging

          # Try to merge main with --no-ff
          if git merge origin/main --no-ff -m "chore: sync staging with main [auto]"; then
            git push origin staging
            echo "result=success" >> $GITHUB_OUTPUT
          else
            # Merge conflict - abort and create issue
            git merge --abort
            echo "result=conflict" >> $GITHUB_OUTPUT
          fi

      - name: Re-enable staging ruleset
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RULESET_ID="${{ steps.disable-ruleset.outputs.ruleset_id }}"

          if [ -n "$RULESET_ID" ]; then
            echo "Re-enabling staging-protection ruleset (ID: $RULESET_ID)..."
            gh api "repos/${{ github.repository }}/rulesets/${RULESET_ID}" -X PUT --input - << EOF
          {
            "name": "staging-protection",
            "enforcement": "active"
          }
          EOF
            echo "âœ“ Ruleset re-enabled"
          fi

      - name: Create issue on conflict
        if: steps.sync.outputs.result == 'conflict'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”´ Manual sync required: main â†’ staging conflict',
              body: `## Automatic Sync Failed

            The automatic sync from \`main\` to \`staging\` encountered merge conflicts.

            ### What happened
            After merging to \`main\`, the system attempted to sync changes to \`staging\` but found conflicts that require manual resolution.

            ### Required action
            1. Checkout the \`staging\` branch locally
            2. Merge \`main\` into \`staging\`: \`git merge origin/main --no-ff\`
            3. Resolve the conflicts
            4. Push the resolved \`staging\` branch

            ### Commands
            \`\`\`bash
            git checkout staging
            git pull origin staging
            git merge origin/main --no-ff
            # Resolve conflicts...
            git add .
            git commit
            git push origin staging
            \`\`\`

            ---
            *This issue was automatically created by the sync-staging workflow.*`,
              labels: ['sync-conflict', 'urgent']
            });

            console.log(`Created issue #${issue.number}`);

      - name: Summary
        run: |
          RESULT="${{ steps.sync.outputs.result }}"
          case "$RESULT" in
            success)
              echo "âœ… Successfully synced main to staging"
              ;;
            created)
              echo "âœ… Created staging branch from main"
              ;;
            conflict)
              echo "âŒ Merge conflict detected - issue created for manual resolution"
              ;;
          esac
